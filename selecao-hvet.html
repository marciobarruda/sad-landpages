<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Seleção Simplificada — HVR | Inscrição</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      :root{
        --brand:#0d6efd; --brand-dark:#0b5ed7; --bg:#f9fbff; --text:#0b2447; --muted:#6c757d;
        --stage-w:1379px;
        --pattern-w:1366px;
      }
      body{
        background:
          radial-gradient(1200px 600px at -10% -10%, #f0f8ff 0%, #ffffff 60%),
          radial-gradient(800px 500px at 110% 0%, #f3f7ff 0%, #ffffff 60%),
          linear-gradient(180deg,#ffffff 0%, #f9fbff 100%);
        min-height:100vh;
        color:var(--text);
      }
      .stage{ width:var(--stage-w); margin:0 auto; position:relative; left:-6px; }
      header.hero{ width:var(--stage-w); height:240px; background:url('https://statics.recife.pe.gov.br/images/dynamics/zonaazul/banner.jpeg') center/cover no-repeat; }
      .pattern-strip{ width:var(--pattern-w); margin:0 auto; position:relative; left:-6px; background:url('https://statics.recife.pe.gov.br/images/dynamics/zonaazul/background.jpeg') repeat center/900px auto; }
      .pattern-top{ height:135px; opacity:.4; }
      .pattern-bottom{ height:135px; opacity:.4; }
      .card-form{ border:0; border-radius:1rem; box-shadow:0 12px 34px rgba(13,110,253,.12), 0 6px 16px rgba(13,110,253,.08); overflow:hidden; }
      .card-form .card-header{ background:linear-gradient(180deg,#ffffff 0%, #f6f9ff 100%); border-bottom:1px solid #eef3ff; }
      .required::after{ content:" *"; color:#dc3545; font-weight:600; }
      .help{ font-size:.9rem; color:#6c757d; }
      .section-title{ font-weight:700; letter-spacing:.2px; color:#0b2447; }
      .dropzone{ border:2px dashed #cfe2ff; border-radius:.75rem; padding:1rem; background:#f8fbff; }
      .form-control:focus,.form-select:focus{ box-shadow:0 0 0 .25rem rgba(13,110,253,.15); border-color:var(--brand); }
      pre.json{ background:#0b1020; color:#e6edf3; border-radius:.75rem; padding:1rem; max-height:40vh; overflow:auto; }
      .badge-soft{ background:#e7f1ff; color:#0b2447; border:1px solid #cfe2ff; }
      .form-control[readonly]{ background:#f8f9fa; }
      .review-table td{ vertical-align: top; }
      .review-placeholder{ color:#adb5bd; font-weight:600; letter-spacing:.04em; }
      .frame-card{
        max-width: 1020px;
        background:#ffffff;
        border-radius:1rem;
        box-shadow:0 18px 40px rgba(13,110,253,.12), 0 8px 22px rgba(13,110,253,.08);
        padding:2rem;
        position:relative; z-index:2;
        margin:-90px auto -90px !important;
      }
      .wizard-shell{
        background:#ffffff;
        border:1px solid #d8e1fb;
        border-radius:1.25rem;
        padding:1.5rem 1.75rem;
        box-shadow:0 18px 36px rgba(13,110,253,.08);
        margin-bottom:2.25rem;
      }
      .wizard-heading{
        font-weight:700;
        letter-spacing:.18em;
        font-size:.75rem;
        text-transform:uppercase;
        color:#5563a5;
        display:flex;
        align-items:center;
        gap:.5rem;
      }
      .wizard-heading::before{
        content:'';
        width:32px;
        height:2px;
        background:rgba(13,110,253,.35);
        border-radius:999px;
      }
      .wizard-steps{
        list-style:none;
        margin:0;
        padding:1.1rem 0 0;
        display:flex;
        align-items:flex-start;
        gap:0;
        position:relative;
        counter-reset:wizard-step;
      }
      .wizard-step{
        flex:1 1 0;
        min-width:0;
        position:relative;
        padding:0 1rem;
        cursor:pointer;
        display:flex;
        flex-direction:column;
        align-items:center;
        text-align:center;
        gap:.45rem;
      }
      .wizard-step::before,
      .wizard-step::after{
        content:'';
        position:absolute;
        top:19px;
        width:50%;
        height:2px;
        background:#dce4ff;
        z-index:0;
      }
      .wizard-step::before{ left:0; }
      .wizard-step::after{ left:50%; }
      .wizard-step:first-child::before{ display:none; }
      .wizard-step:last-child::after{ display:none; }
      .wizard-step.completed::before,
      .wizard-step.completed::after,
      .wizard-step.active::before{
        background:linear-gradient(90deg,var(--brand) 0%, var(--brand-dark) 100%);
      }
      .wizard-step .wizard-index{
        width:38px;
        height:38px;
        border-radius:50%;
        border:3px solid #dce4ff;
        background:#ffffff;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:700;
        color:#6a77b4;
        z-index:1;
        transition:all .2s ease;
        box-shadow:0 6px 12px rgba(13,110,253,.08);
      }
      .wizard-step .wizard-label{
        font-weight:600;
        letter-spacing:.04em;
        font-size:.92rem;
        color:#516098;
      }
      .wizard-step.active .wizard-index{
        border-color:var(--brand);
        color:#ffffff;
        background:linear-gradient(135deg,var(--brand) 0%, var(--brand-dark) 100%);
        box-shadow:0 10px 20px rgba(13,110,253,.22);
      }
      .wizard-step.completed .wizard-index{
        border-color:#2ca46d;
        background:#2ca46d;
        color:#ffffff;
      }
      .wizard-step.active .wizard-label{
        color:var(--brand-dark);
      }
      .wizard-step.completed .wizard-label{
        color:#2c7a52;
      }
      .wizard-step:hover .wizard-index{
        transform:translateY(-2px);
      }
      .wizard-progress{ display:none; }
      .step-panel{ display:none; }
      .step-panel.active{ display:block; animation:fadeIn .3s ease; }
      @keyframes fadeIn{ from{ opacity:0; transform:translateY(12px);} to{ opacity:1; transform:translateY(0);} }
      .wizard-controls{ display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-top:1.5rem; }
      .wizard-controls .spacer{ flex:1; }
      .wizard-controls .btn{ min-width:140px; }
      .subtle{ color:#6c757d; font-weight:500; letter-spacing:.2px; }
      .floating-save{ position:fixed; right:1rem; bottom:1rem; z-index:50; }
      .tiny{ font-size:.85rem; }
      .pill{ border-radius:999px; padding:.25rem .6rem; border:1px solid #dee2e6; }
      .uploader-status{ min-height:1.75rem; }
      .declaration-box{
        background:#f8f9fa;
        border:1px solid #dbe7ff;
        border-radius:.75rem;
        padding:1rem 1.25rem;
        max-height:240px;
        overflow:auto;
        font-size:.95rem;
        line-height:1.55;
        color:#0b2447;
      }
      .declaration-box strong{ letter-spacing:.3px; }
      .declaration-box::-webkit-scrollbar{ width:8px; }
      .declaration-box::-webkit-scrollbar-thumb{ background:#c7d5f8; border-radius:999px; }
      .declaration-check{ margin-top:1rem; }
      .declaration-actions .btn{ min-width:140px; }
      @media (max-width: 992px){
        :root{ --stage-w:100vw; --pattern-w:100vw; }
        .stage, .pattern-strip{ left:0; }
        header.hero{ background-position:center; background-size:cover; }
        body{ overflow-x:hidden; }
        .frame-card{ margin:-60px auto -60px; padding:1.25rem; }
        .wizard-shell{ padding:1.25rem 1.1rem; }
        .wizard-heading::before{ width:24px; }
        .wizard-steps{
          overflow-x:auto;
          gap:1.5rem;
          padding:1rem 0 1.25rem;
          margin:0 -.5rem;
          scrollbar-width:thin;
        }
        .wizard-steps::-webkit-scrollbar{ height:6px; }
        .wizard-steps::-webkit-scrollbar-thumb{ background:#c2cff6; border-radius:999px; }
        .wizard-step{
          min-width:160px;
          align-items:flex-start;
          text-align:left;
          padding:0 .75rem;
        }
        .wizard-step::before,
        .wizard-step::after{
          top:18px;
        }
      }
      @media (max-width: 576px){
        .wizard-step{ min-width:150px; }
        .wizard-step .wizard-index{ width:34px; height:34px; }
        .wizard-step .wizard-label{ font-size:.88rem; }
        .racial-declaration-box{ max-height:200px; }
        .wizard-step::before,
        .wizard-step::after{ top:17px; }
      }
    </style>
  </head>
  <body>
    <header class="hero stage"></header>
    <div class="pattern-strip pattern-top"></div>

    <main class="container my-4 frame-card" id="app">
      <div class="text-center mb-4">
        <h1 class="h4 mb-1">Seleção Simplificada — Hospital Veterinário do Recife</h1>
        <p class="text-muted subtle">Inscrição on-line</p>
      </div>

      <div class="wizard-shell">
        <h2 class="h6 text-uppercase text-muted wizard-heading mb-3">Etapas da inscrição</h2>
        <p class="tiny text-muted mb-3">Acompanhe o avanço das etapas e navegue rapidamente pelo formulário.</p>
        <ol class="wizard-steps" role="tablist">
          <li class="wizard-step active" data-step="0" role="tab" aria-selected="true" tabindex="0">
            <span class="wizard-index">1</span>
            <span class="wizard-label">Documentos</span>
          </li>
          <li class="wizard-step" data-step="1" role="tab" aria-selected="false" tabindex="-1">
            <span class="wizard-index">2</span>
            <span class="wizard-label">Identificação</span>
          </li>
          <li class="wizard-step" data-step="2" role="tab" aria-selected="false" tabindex="-1">
            <span class="wizard-index">3</span>
            <span class="wizard-label">Contato &amp; Endereço</span>
          </li>
          <li class="wizard-step" data-step="3" role="tab" aria-selected="false" tabindex="-1">
            <span class="wizard-index">4</span>
            <span class="wizard-label">Formação &amp; Vínculos</span>
          </li>
          <li class="wizard-step" data-step="4" role="tab" aria-selected="false" tabindex="-1">
            <span class="wizard-index">5</span>
            <span class="wizard-label">Cotas &amp; Acessibilidade</span>
          </li>
          <li class="wizard-step" data-step="5" role="tab" aria-selected="false" tabindex="-1">
            <span class="wizard-index">6</span>
            <span class="wizard-label">Revisão final</span>
          </li>
        </ol>
        <div class="wizard-progress" aria-hidden="true">
          <div class="progress-bar" id="wizardProgressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
        </div>
      </div>

      <section class="step-panel active" data-step-panel="0" aria-label="Etapa 1 - Documentos">
        <div class="card card-form mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">Documentos</h2>
            <span class="badge badge-soft">2 MB por doc/foto • 30 MB vídeo</span>
          </div>
          <div class="card-body">
            <ul class="tiny mb-3">
              <li>Documentos/fotos: PDF, JPG, JPEG, PNG (até 2 MB cada).</li>
              <li>Vídeo (heteroidentificação): MP4, MOV (até 30 MB).</li>
            </ul>

            <section class="mb-4">
              <h3 class="h6 section-title mb-2">1) Cadastro</h3>
              <div class="row g-3 align-items-end">
                <div class="col-md-8">
                  <label class="form-label required">Documento de identificação oficial com foto (frente)</label>
                  <div class="dropzone"><input class="form-control" type="file" id="doc_id_frente" accept=".pdf,image/*" required></div>
                </div>
                <div class="col-md-4"><div id="status_doc_id_frente" class="uploader-status ms-auto"></div></div>

                <div class="col-md-8">
                  <label class="form-label required">Documento de identificação oficial com foto (verso)</label>
                  <div class="dropzone"><input class="form-control" type="file" id="doc_id_verso" accept=".pdf,image/*" required></div>
                </div>
                <div class="col-md-4"><div id="status_doc_id_verso" class="uploader-status ms-auto"></div></div>

                <div class="col-md-8">
                  <label class="form-label required">Comprovante de residência</label>
                  <div class="dropzone"><input class="form-control" type="file" id="doc_residencia" accept=".pdf,image/*" required></div>
                </div>
                <div class="col-md-4"><div id="status_doc_res" class="uploader-status ms-auto"></div></div>

                <div class="col-md-8">
                  <label class="form-label required">Quitação eleitoral</label>
                  <div class="dropzone"><input class="form-control" type="file" id="doc_quitacao_eleitoral" accept=".pdf,image/*" required></div>
                </div>
                <div class="col-md-4"><div id="status_doc_eleitoral" class="uploader-status ms-auto"></div></div>

                <div class="col-md-8 d-none" id="docMilitarWrap">
                  <label class="form-label" id="docMilitarLabel">Quitação do serviço militar</label>
                  <div class="dropzone"><input class="form-control" type="file" id="doc_militar" accept=".pdf,image/*"></div>
                  <div class="help tiny">CAM / CDI / CI / CRM.</div>
                </div>
                <div class="col-md-4 d-none" id="status_doc_militar_wrap"><div id="status_doc_militar" class="uploader-status ms-auto"></div></div>

                <div class="col-md-8">
                  <label class="form-label required">Comprovação da escolaridade</label>
                  <div class="dropzone"><input class="form-control" type="file" id="doc_escolaridade" accept=".pdf,image/*" required></div>
                </div>
                <div class="col-md-4"><div id="status_doc_escolaridade" class="uploader-status ms-auto"></div></div>

                <div class="col-md-8">
                  <label class="form-label">Experiência / títulos / certificados</label>
                  <div class="dropzone"><input class="form-control" type="file" id="doc_curriculo" accept=".pdf,image/*" multiple></div>
                </div>
                <div class="col-md-4"><div id="status_doc_curriculo" class="uploader-status ms-auto"></div></div>
              </div>
            </section>

            <hr>

            <section class="mb-4">
              <h3 class="h6 section-title mb-2">2) Heteroidentificação (se PNP)</h3>
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">Documento de identidade (frente/verso)</label>
                  <div class="dropzone"><input class="form-control" type="file" id="het_id" accept=".pdf,image/*" multiple></div>
                </div>
                <div class="col-md-4 d-flex align-items-end"><div id="status_het_id" class="uploader-status ms-auto"></div></div>

                <div class="col-md-6">
                  <label class="form-label">Foto de frente</label>
                  <div class="dropzone"><input class="form-control" type="file" id="het_frente" accept="image/*"></div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Foto de perfil</label>
                  <div class="dropzone"><input class="form-control" type="file" id="het_perfil" accept="image/*"></div>
                </div>

                <div class="col-md-12">
                  <label class="form-label">Vídeo (até 20s)</label>
                  <div class="dropzone"><input class="form-control" type="file" id="het_video" accept="video/mp4,video/quicktime"></div>
                  <div class="help tiny">Diga: “declaro que sou negro, da cor preta ou parda”.</div>
                </div>
              </div>
            </section>

            <hr>

            <section id="pcdDocsSection" class="mb-2 d-none">
              <h3 class="h6 section-title mb-2">3) Avaliação biopsicossocial (PCD)</h3>
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">Laudo médico</label>
                  <div class="dropzone"><input class="form-control" type="file" id="pcd_laudo" accept=".pdf,.png,.jpeg,.jpg,.gif"></div>
                </div>
                <div class="col-md-4 d-flex align-items-end"><div id="status_pcd_laudo" class="uploader-status ms-auto"></div></div>
              </div>
            </section>
          </div>
        </div>

        <div class="wizard-controls">
          <span class="spacer"></span>
          <button type="button" class="btn btn-primary" data-step-nav="next">Avançar</button>
        </div>
      </section>

      <section class="step-panel" data-step-panel="1" aria-label="Etapa 2 - Identificação">
        <div class="card card-form mb-4">
          <div class="card-header">
            <h2 class="h5 mb-0">Identificação civil</h2>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label required" for="cpf">CPF</label>
                <input type="text" id="cpf" class="form-control" inputmode="numeric" maxlength="11" value="{{ $json.preferred_username ?? '' }}" required>
                <div class="help tiny" id="cpfHelp"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="nome">Nome completo</label>
                <input type="text" id="nome" class="form-control" value="{{ String($json.name ?? '').trim() || String($json.socialName ?? '').trim().toUpperCase() }}" required>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="nasc">Data de nascimento</label>
                <input type="date" id="nasc" class="form-control" value="{{ ($json.dob||'').split('/').reverse().join('-') }}" required>
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-4">
                <label class="form-label required" for="nacionalidade">Nacionalidade</label>
                <input type="text" id="nacionalidade" class="form-control" required>
              </div>
              <div class="col-md-5">
                <label class="form-label required" for="naturalidade_cidade">Naturalidade</label>
                <input type="text" id="naturalidade_cidade" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="naturalidade_uf">UF</label>
                <input type="text" id="naturalidade_uf" maxlength="2" class="form-control" required>
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-4">
                <label class="form-label required" for="genero">Gênero</label>
                <select id="genero" class="form-select" required>
                  <option value="">Selecione...</option>
                  <option>Feminino</option>
                  <option>Masculino</option>
                  <option>Outro</option>
                </select>
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-3">
                <label class="form-label required" for="rg_numero">RG</label>
                <input type="text" id="rg_numero" class="form-control" inputmode="numeric" maxlength="14" required>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="rg_orgao">Órgão</label>
                <input type="text" id="rg_orgao" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="rg_uf">UF</label>
                <input type="text" id="rg_uf" maxlength="2" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="rg_data">Expedição</label>
                <input type="date" id="rg_data" class="form-control" required>
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-4">
                <label class="form-label" for="pis_pasep">PIS/PASEP</label>
                <input type="text" id="pis_pasep" class="form-control">
              </div>
            </div>
          </div>
        </div>

        <div class="card card-form mb-4">
          <div class="card-header">
            <h2 class="h5 mb-0">Situação militar e eleitoral</h2>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4 d-none" id="militarPergunta">
                <label class="form-label" id="militarPerguntaLabel">Obrigações militares em dia?</label><br>
                <div class="d-flex gap-3">
                  <div class="form-check"><input class="form-check-input" type="radio" name="militar" id="militar_sim" value="SIM"><label class="form-check-label" for="militar_sim">Sim</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" name="militar" id="militar_nao" value="NAO"><label class="form-check-label" for="militar_nao">Não</label></div>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label required">Em pleno gozo dos direitos políticos?</label><br>
                <div class="d-flex gap-3">
                  <div class="form-check"><input class="form-check-input" type="radio" name="politicos" id="politicos_sim" value="SIM"><label class="form-check-label" for="politicos_sim">Sim</label></div>
                  <div class="form-check"><input class="form-check-input" type="radio" name="politicos" id="politicos_nao" value="NAO"><label class="form-check-label" for="politicos_nao">Não</label></div>
                </div>
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-4">
                <label class="form-label" for="titulo">Título de Eleitor</label>
                <input type="text" id="titulo" class="form-control" inputmode="numeric" maxlength="12">
              </div>
              <div class="col-md-4">
                <label class="form-label" for="zona">Zona</label>
                <input type="text" id="zona" class="form-control" inputmode="numeric" maxlength="4">
              </div>
              <div class="col-md-4">
                <label class="form-label" for="secao">Seção</label>
                <input type="text" id="secao" class="form-control" inputmode="numeric" maxlength="4">
              </div>
            </div>
          </div>
        </div>

        <div class="wizard-controls">
          <button type="button" class="btn btn-outline-secondary" data-step-nav="prev">Voltar</button>
          <button type="button" class="btn btn-primary" data-step-nav="next">Avançar</button>
        </div>
      </section>

      <section class="step-panel" data-step-panel="2" aria-label="Etapa 3 - Contato e endereço">
        <div class="card card-form mb-4">
          <div class="card-header">
            <h2 class="h5 mb-0">Contato</h2>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label required" for="email">E-mail</label>
                <input type="email" id="email" class="form-control" value="{{ $json.email ?? '' }}" required>
                <div class="help tiny" id="emailHelp"></div>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="tel1">Telefone 1</label>
                <input type="text" id="tel1" class="form-control" inputmode="numeric" maxlength="11" placeholder="DDD + número" required>
                <div class="help tiny" id="tel1Help"></div>
              </div>
              <div class="col-md-3">
                <label class="form-label" for="tel2">Telefone 2</label>
                <input type="text" id="tel2" class="form-control" inputmode="numeric" maxlength="11" placeholder="DDD + número">
                <div class="help tiny" id="tel2Help"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-form mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">Endereço</h2>
            <span class="badge badge-soft">ViaCEP / BrasilAPI</span>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label required" for="cep">CEP</label>
                <input type="text" id="cep" class="form-control" placeholder="00000-000" inputmode="numeric" maxlength="8" value="{{ $json.postal_code ?? '' }}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="logradouro">Logradouro</label>
                <input type="text" id="logradouro" class="form-control" value="{{ $json.addressStreet ?? '' }}" required>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="numero">Número</label>
                <input type="text" id="numero" class="form-control" value="{{ $json.addressNumber ?? '' }}" required>
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-4">
                <label class="form-label" for="complemento">Complemento</label>
                <input type="text" id="complemento" class="form-control" value="{{ $json.addressComplement ?? '' }}">
              </div>
              <div class="col-md-4">
                <label class="form-label required" for="bairro">Bairro</label>
                <input type="text" id="bairro" class="form-control" value="{{ $json.neighborhood ?? '' }}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label required" for="cidade">Cidade</label>
                <input type="text" id="cidade" class="form-control" value="{{ $json.locality ?? '' }}" required>
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-3">
                <label class="form-label required" for="uf">UF</label>
                <input type="text" id="uf" class="form-control" maxlength="2" value="{{ $json.state ?? '' }}" required>
              </div>
            </div>
          </div>
        </div>

        <div class="wizard-controls">
          <button type="button" class="btn btn-outline-secondary" data-step-nav="prev">Voltar</button>
          <button type="button" class="btn btn-primary" data-step-nav="next">Avançar</button>
        </div>
      </section>

      <section class="step-panel" data-step-panel="3" aria-label="Etapa 4 - Formação e vínculos">
        <div class="card card-form mb-4">
          <div class="card-header">
            <h2 class="h5 mb-0">Escolaridade e formação</h2>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label required" for="nivel">Nível</label>
                <select id="nivel" class="form-select" required>
                  <option value="">Selecione...</option>
                  <option>Fundamental</option>
                  <option>Médio</option>
                  <option>Técnico</option>
                  <option>Superior</option>
                  <option>Pós-graduação</option>
                  <option>Doutorado</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="ies">Instituição</label>
                <input type="text" id="ies" class="form-control" required>
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-9">
                <label class="form-label required" for="curso">Curso</label>
                <input type="text" id="curso" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label required" for="ano_conclusao">Ano</label>
                <input type="text" id="ano_conclusao" class="form-control" inputmode="numeric" maxlength="4" required>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-form mb-4">
          <div class="card-header">
            <h2 class="h5 mb-0">Experiência e vínculos</h2>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label required" for="vinculo_publico">Vínculo com serviço público?</label>
                <select id="vinculo_publico" class="form-select" required>
                  <option value="">Selecione...</option>
                  <option>Sim</option>
                  <option>Não</option>
                </select>
              </div>
            </div>
            <div id="vinculoDetalhes" class="row g-3 mt-0 d-none">
              <div class="col-md-6">
                <label class="form-label" for="qual_vinculo">Qual vínculo</label>
                <input type="text" id="qual_vinculo" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label" for="experiencia_tempo">Tempo (meses/anos)</label>
                <input type="text" id="experiencia_tempo" class="form-control">
              </div>
            </div>
          </div>
        </div>

        <div class="wizard-controls">
          <button type="button" class="btn btn-outline-secondary" data-step-nav="prev">Voltar</button>
          <button type="button" class="btn btn-primary" data-step-nav="next">Avançar</button>
        </div>
      </section>

      <section class="step-panel" data-step-panel="4" aria-label="Etapa 5 - Cotas e acessibilidade">
        <div class="card card-form mb-4">
          <div class="card-header">
            <h2 class="h5 mb-0">Informações de raça e cotas</h2>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label required" for="raca">Cor/Raça (IBGE)</label>
                <select id="raca" class="form-select" required>
                  <option value="">Selecione...</option>
                  <option>Branca</option>
                  <option>Preta</option>
                  <option>Parda</option>
                  <option>Amarela</option>
                  <option>Indígena</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label required" for="cotasPNP">Concorrer às vagas PNP?</label>
                <select id="cotasPNP" class="form-select" required>
                  <option value="">Selecione...</option>
                  <option>Sim</option>
                  <option>Não</option>
                </select>
              </div>
            </div>
            <div class="help tiny mt-2">Se optar por PNP, serão exigidos arquivos de heteroidentificação abaixo.</div>
          </div>
        </div>

        <div class="card card-form mb-4">
          <div class="card-header">
            <h2 class="h5 mb-0">Pessoa com Deficiência (PCD)</h2>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label required" for="is_pcd">É PCD?</label>
                <select id="is_pcd" class="form-select" required>
                  <option value="">Selecione...</option>
                  <option>Sim</option>
                  <option>Não</option>
                </select>
              </div>
              <div id="pcdDetalhes" class="col-md-9 d-none">
                <div class="row g-3">
                  <div class="col-md-5">
                    <label class="form-label" for="tipo_pcd">Tipo de deficiência</label>
                    <input type="text" id="tipo_pcd" class="form-control">
                  </div>
                  <div class="col-md-7">
                    <label class="form-label" for="necessidade">Necessidade especial (provas/etapas)</label>
                    <input type="text" id="necessidade" class="form-control">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="wizard-controls">
          <button type="button" class="btn btn-outline-secondary" data-step-nav="prev">Voltar</button>
          <button type="button" class="btn btn-primary" data-step-nav="next">Avançar</button>
        </div>
      </section>

      <section class="step-panel" data-step-panel="5" aria-label="Etapa 6 - Revisão e envio">
        <div class="card card-form mb-5">
          <div class="card-header">
            <h2 class="h5 mb-0">Revisão e envio</h2>
          </div>
          <div class="card-body">
            <div id="reviewBlock" class="mb-3"></div>

            <div class="mb-4">
              <h3 class="h6 section-title mb-2">Autodeclaração étnico-racial</h3>
              <div id="racialDeclarationText" class="declaration-box" tabindex="0" role="textbox" aria-readonly="true"></div>
              <div class="form-check declaration-check">
                <input class="form-check-input" type="checkbox" id="racialDeclarationAgree" disabled>
                <label class="form-check-label" for="racialDeclarationAgree">Confirmo que a autodeclaração acima corresponde à minha manifestação.</label>
              </div>
              <div class="form-text tiny mt-2" id="racialDeclarationHint">Role o texto até o final para habilitar o aceite.</div>
            </div>

            <div class="mb-4">
              <h3 class="h6 section-title mb-2">Declaração de responsabilidade</h3>
              <div id="responsibilityText" class="declaration-box" tabindex="0" role="textbox" aria-readonly="true">
                DECLARO que todas as informações fornecidas são verdadeiras e exatas, DECLARO, ainda, estar ciente de que prestar declaração falsa caracteriza o crime de falsidade ideológica previsto no art. 299 do Código Penal Brasileiro, e que por tal crime serei responsabilizado, independentemente das sanções administrativas, caso se comprove a inveracidade do declarado neste documento. DECLARO estar ciente e de acordo com os termos da Política de Privacidade, nos termos da Lei nº 13.709/2018 (Lei Geral de Proteção de Dados Pessoais – LGPD). DECLARO, por fim, que tomo ciência, neste ato, de toda a legislação mencionada acima.
              </div>
              <div class="form-check declaration-check">
                <input class="form-check-input" type="checkbox" id="termoResponsabilidade" disabled>
                <label class="form-check-label" for="termoResponsabilidade">Li e estou de acordo com a declaração de responsabilidade.</label>
              </div>
              <div class="form-text tiny mt-2" id="responsibilityHint">Role o texto até o final para habilitar o aceite.</div>
            </div>

            <div class="d-flex flex-wrap gap-2 declaration-actions mb-3">
              <button type="button" class="btn btn-outline-success" id="acceptAllDeclarations">Aceitar tudo</button>
              <button type="button" class="btn btn-outline-danger" id="declineAllDeclarations">Não aceitar</button>
            </div>

            <div class="d-flex gap-2">
              <button type="button" class="btn btn-secondary" id="btnSubmitAll" disabled>Enviar dados</button>
              <div id="finalStatus" class="ms-2"></div>
            </div>
            <pre class="json mt-3 d-none" id="finalOut"></pre>
          </div>
        </div>

        <div class="wizard-controls">
          <button type="button" class="btn btn-outline-secondary" data-step-nav="prev">Voltar</button>
          <span class="spacer"></span>
        </div>
      </section>

      <div class="text-center text-muted tiny mb-5">Pré-validações locais. A conferência oficial seguirá o Edital do certame.</div>
    </main>

    <div class="pattern-strip pattern-bottom"></div>
    <button class="btn btn-primary rounded-pill shadow floating-save" id="quickSave" type="button">Salvar rascunho</button>

    <script>
      // ========= Config =========
      const FINAL_ENDPOINT = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/inscricao-hvr";
      const DOC_ID_ENDPOINT = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/doc-id";
      const QUITACAO_ENDPOINT = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/quitacao-eleitoral";
      const RESIDENCIA_ENDPOINT = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/comprovante-residencia";
      const ESCOLARIDADE_ENDPOINT = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/comprovante-escolaridade";
      const DOC_OK_EXT = ['pdf','jpg','jpeg','png'];
      const DOC_MAX_MB = 2;
      const VID_OK_EXT = ['mp4','mov'];
      const VID_MAX_MB = 30;

      // ========= Utils =========
      const $ = (sel) => document.querySelector(sel);
      const onlyDigits = (s) => (s||'').replace(/\\D+/g, '');
      const esc = s => { const d=document.createElement('div'); d.innerText=s??''; return d.innerHTML||''; };
      const fmtCPF = v => { const d = onlyDigits(v||''); return d.length===11 ? d.replace(/(\\d{3})(\\d{3})(\\d{3})(\\d{2})/,'$1.$2.$3-$4') : (d||''); };
      const fmtCEP = v => { const d = onlyDigits(v||''); return d.length===8 ? d.replace(/(\\d{5})(\\d{3})/,'$1-$2') : (d||''); };
      const toMB = bytes => Math.round((bytes/1024/1024)*100)/100;

      // ========= Validators =========
      function isValidEmail(v){ return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$/.test(String(v||'').trim()); }
      function isValidCPF(cpf){
        cpf = onlyDigits(cpf);
        if(!cpf || cpf.length !== 11) return false;
        if(/^([0-9])\\1+$/.test(cpf)) return false;
        let soma=0, rest;
        for(let i=1;i<=9;i++) soma += parseInt(cpf.substring(i-1,i))*(11-i);
        rest=(soma*10)%11; if(rest===10||rest===11) rest=0; if(rest!==parseInt(cpf.substring(9,10))) return false;
        soma=0; for(let i=1;i<=10;i++) soma += parseInt(cpf.substring(i-1,i))*(12-i);
        rest=(soma*10)%11; if(rest===10||rest===11) rest=0; if(rest!==parseInt(cpf.substring(10,11))) return false;
        return true;
      }
      function checkFiles(input, {video=false, required=false, minFiles=1}){
        const files = Array.from(input.files||[]);
        if(required && files.length < minFiles){ return {ok:false, msg:`Selecione pelo menos ${minFiles} arquivo(s).`}; }
        for(const f of files){
          const e = (String(f.name).split('.').pop()||'').toLowerCase();
          if(video){
            if(!VID_OK_EXT.includes(e)) return {ok:false, msg:`Inválido (${e}). Aceitos: ${VID_OK_EXT.join(', ').toUpperCase()}`};
            if(toMB(f.size) > VID_MAX_MB) return {ok:false, msg:`Vídeo > ${VID_MAX_MB} MB: ${toMB(f.size)} MB`};
          }else{
            if(!DOC_OK_EXT.includes(e)) return {ok:false, msg:`Inválido (${e}). Aceitos: ${DOC_OK_EXT.join(', ').toUpperCase()}`};
            if(toMB(f.size) > DOC_MAX_MB) return {ok:false, msg:`Arquivo > ${DOC_MAX_MB} MB: ${toMB(f.size)} MB`};
          }
        }
        return {ok:true, msg:`${files.length} arquivo(s) ok`};
      }
      function setStatus(el, type, msg, spinning=false){
        const spinner = spinning ? '<span class="spinner-border spinner-border-sm align-middle ms-2"></span>' : '';
        el.innerHTML = '<span class="badge text-bg-'+type+' d-inline-flex align-items-center">'+esc(msg)+spinner+'</span>';
      }
      const ok = (el,msg='Ok')=>setStatus(el,'success',msg);
      const bad = (el,msg='Inválido')=>setStatus(el,'danger',msg);

      // ========= CEP (ViaCEP + BrasilAPI) =========
      async function lookupCep(cep){
        const normalized = onlyDigits(cep);
        if(normalized.length !== 8) return null;
        const providers = [
          async () => {
            const res = await fetch(`https://viacep.com.br/ws/${normalized}/json/`);
            if(!res.ok) throw new Error(`ViaCEP HTTP ${res.status}`);
            const data = await res.json();
            if(data?.erro) return null;
            return { logradouro:data.logradouro, bairro:data.bairro, cidade:data.localidade, uf:data.uf };
          },
          async () => {
            const res = await fetch(`https://brasilapi.com.br/api/cep/v1/${normalized}`);
            if(!res.ok) throw new Error(`BrasilAPI HTTP ${res.status}`);
            const data = await res.json();
            if(data?.errors || data?.error || data?.message) return null;
            return {
              logradouro: data.street || data.logradouro,
              bairro: data.neighborhood || data.bairro,
              cidade: data.city || data.localidade,
              uf: data.state || data.uf
            };
          }
        ];
        for(const p of providers){
          try{ const r=await p(); if(r) return r; }catch(e){ console.warn('CEP provider fail', e); }
        }
        return null;
      }
      async function autofillAddressByCep(){
        const cep = onlyDigits($('#cep').value);
        if(cep.length !== 8) return;
        const data = await lookupCep(cep);
        if(!data) return;
        $('#logradouro').value=String(data.logradouro||'').toUpperCase();
        $('#bairro').value=String(data.bairro||'').toUpperCase();
        $('#cidade').value=String(data.cidade||'').toUpperCase();
        $('#uf').value=(data.uf||'').toUpperCase();
        updateReview();
        refreshSubmitState();
      }

      // ========= Review =========
      const reviewPlaceholder = '';
      const fmtDateBr = iso => {
        if(!iso) return '';
        const [y,m,d] = String(iso).split('-');
        if(y && m && d) return `${d}/${m}/${y}`;
        return '';
      };
      const parseToIsoDate = (value) => {
        if(!value) return '';
        const str = String(value).trim();
        if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(str)){
          const [d,m,y] = str.split('/');
          return `${y}-${m}-${d}`;
        }
        const dt = new Date(str);
        if(!Number.isNaN(dt.getTime())){
          const y = dt.getFullYear();
          const m = String(dt.getMonth()+1).padStart(2,'0');
          const d = String(dt.getDate()).padStart(2,'0');
          return `${y}-${m}-${d}`;
        }
        return '';
      };
      const fmtPhone = (value) => {
        const digits = onlyDigits(value).slice(0,11);
        return digits;
      };
      const isValidPhone = (value) => {
        const digits = onlyDigits(value);
        return /^(?:[1-9][0-9])(?:9[0-9]{8}|[2-9][0-9]{7})$/.test(digits);
      };
      const isAdult = (value) => {
        if(!value) return false;
        const parts = String(value).split('-');
        if(parts.length !== 3) return false;
        const [y,m,d] = parts.map(Number);
        if(!y || !m || !d) return false;
        const birth = new Date(y, m - 1, d);
        if(Number.isNaN(birth.getTime())) return false;
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if(monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())){
          age--;
        }
        return age >= 18;
      };
      const joinParts = (parts, sep=' / ') => parts.map(part => String(part||'').trim()).filter(Boolean).join(sep);
      const isGeneroMasculino = () => String($('#genero')?.value || '').trim().toUpperCase() === 'MASCULINO';
      const pickDataValue = (source, keys=[]) => {
        if(!source || typeof source !== 'object') return '';
        for(const key of keys){
          if(key in source){
            const val = source[key];
            if(val !== undefined && val !== null){
              const str = String(val).trim();
              if(str) return str;
            }
          }
        }
        return '';
      };
      const applyIfEmpty = (selector, value, transform) => {
        const el = $(selector);
        if(!el) return;
        const current = String(el.value || '').trim();
        if(current) return;
        if(value === undefined || value === null) return;
        const transformed = transform ? transform(value) : value;
        const finalValue = transformed === undefined || transformed === null ? '' : String(transformed);
        if(!finalValue.trim()) return;
        el.value = finalValue;
        ['input','change'].forEach(evt => el.dispatchEvent(new Event(evt,{bubbles:true})));
      };
      const resetUploaderStatus = (id) => {
        const el = document.getElementById(id);
        if(el){
          el.textContent = '';
          el.className = 'uploader-status ms-auto';
        }
      };
      const present = value => {
        if(value === undefined || value === null) return reviewPlaceholder;
        const str = String(value).trim();
        return str ? esc(str) : reviewPlaceholder;
      };
      const racialDeclarationBox = $('#racialDeclarationText');
      const racialCheckbox = $('#racialDeclarationAgree');
      const racialHint = $('#racialDeclarationHint');
      const responsibilityBox = $('#responsibilityText');
      const responsibilityCheckbox = $('#termoResponsabilidade');
      const responsibilityHint = $('#responsibilityHint');
      let lastRacialSignature = '';
      const declarationDateFormatter = new Intl.DateTimeFormat('pt-BR');

      function resetDeclaration(box, checkbox, hint){
        if(!box || !checkbox) return;
        checkbox.checked = false;
        checkbox.disabled = true;
        if(hint){
          hint.textContent = 'Role o texto até o final para habilitar o aceite.';
        }
        requestAnimationFrame(()=>{ box.scrollTop = 0; });
        refreshSubmitState();
      }

      function markDeclarationReady(checkbox, hint){
        if(!checkbox) return;
        if(!checkbox.disabled) return;
        checkbox.disabled = false;
        if(hint){
          hint.textContent = 'Marque o checkbox para confirmar.';
        }
      }

      function handleScrollable(box, checkbox, hint){
        if(!box || !checkbox) return;
        const reachedBottom = Math.ceil(box.scrollTop + box.clientHeight) >= box.scrollHeight - 4;
        if(reachedBottom){
          markDeclarationReady(checkbox, hint);
        }
      }

      function updateRacialDeclaration(){
        if(!racialDeclarationBox) return;
        const nomeUpper = String($('#nome')?.value || '').trim().toUpperCase();
        const cpfDigits = onlyDigits($('#cpf')?.value);
        const cpfFormatted = cpfDigits ? fmtCPF(cpfDigits) : '';
        const racaSelect = $('#raca');
        const racaLabel = racaSelect && racaSelect.value ? String(racaSelect.selectedOptions[0]?.textContent || '').trim().toUpperCase() : '';
        const generoSelect = $('#genero');
        const generoUpper = generoSelect && generoSelect.value ? String(generoSelect.value).trim().toUpperCase() : '';
        const autodeclaradoWord = generoUpper === 'FEMININO' ? 'AUTODECLARADA' : generoUpper === 'MASCULINO' ? 'AUTODECLARADO' : 'AUTODECLARANTE';
        const cidadeUpper = String($('#cidade')?.value || '').trim().toUpperCase();
        const raceKey = racaLabel ? racaLabel.normalize('NFD').replace(/[\u0300-\u036f]/g,'') : '';
        const raceGenderMap = {
          FEMININO: { BRANCA:'BRANCA', PRETA:'PRETA', PARDA:'PARDA', AMARELA:'AMARELA', INDIGENA:'INDÍGENA' },
          MASCULINO: { BRANCA:'BRANCO', PRETA:'PRETO', PARDA:'PARDO', AMARELA:'AMARELO', INDIGENA:'INDÍGENA' }
        };
        let raceDisplay = racaLabel;
        if(raceKey){
          const map = raceGenderMap[generoUpper] || null;
          if(map && map[raceKey]){
            raceDisplay = map[raceKey];
          }else if(raceGenderMap.FEMININO[raceKey]){
            raceDisplay = raceGenderMap.FEMININO[raceKey];
          }
        }
        const signature = [nomeUpper, cpfDigits, raceDisplay, cidadeUpper, autodeclaradoWord].join('|');
        const nameSegment = nomeUpper ? `<strong>${esc(nomeUpper)}</strong>` : '____________________________';
        const cpfSegment = cpfFormatted ? `<strong>${esc(cpfFormatted.toUpperCase())}</strong>` : '________________';
        const raceSegment = raceDisplay ? `<strong>${esc(raceDisplay)}</strong>` : '________________';
        const autodeclaradoSegment = autodeclaradoWord ? `<strong>${esc(autodeclaradoWord)}</strong>` : '________________';
        const citySegment = cidadeUpper ? `<strong>${esc(cidadeUpper)}</strong>` : '________________';
        const dateStr = declarationDateFormatter.format(new Date());
        const raceSentence = `sou ${autodeclaradoSegment} ${raceSegment}.`;
        const locationLine = [citySegment, `<strong>${esc(dateStr)}</strong>`].filter(Boolean).join(', ');
        const template = [
          'Para fins do disposto na Portaria do Ministério do Trabalho nº3784/2023, em cumprimento da Lei 14.553/02023.',
          'As informações relativas à etnia e raça devem ser obrigatoriamente prestadas nas inclusões, alterações ou retificações cadastrais dos trabalhadores, respeitando o critério de autodeclaração do trabalhador, em conformidade com a classificação utilizada pelo Instituto Brasileiro de Geografia e Estatística– IBGE.',
          '',
          `Eu, ${nameSegment},`,
          `portador do CPF nº ${cpfSegment}, AUTODECLARO, sob penas de lei que,`,
          raceSentence,
          '',
          'Por ser expressão da verdade, firmo e assino a presente para que a mesma produza seus efeitos legais e de direito.',
          locationLine
        ].join('\n');
        const hasChanged = signature !== lastRacialSignature;
        if(hasChanged){
          lastRacialSignature = signature;
          resetDeclaration(racialDeclarationBox, racialCheckbox, racialHint);
        }
        racialDeclarationBox.innerHTML = template;
      }

      racialDeclarationBox?.addEventListener('scroll', ()=>handleScrollable(racialDeclarationBox, racialCheckbox, racialHint));
      responsibilityBox?.addEventListener('scroll', ()=>handleScrollable(responsibilityBox, responsibilityCheckbox, responsibilityHint));
      racialCheckbox?.addEventListener('change', refreshSubmitState);
      responsibilityCheckbox?.addEventListener('change', refreshSubmitState);

      const acceptAllBtn = $('#acceptAllDeclarations');
      const declineAllBtn = $('#declineAllDeclarations');
      acceptAllBtn?.addEventListener('click', ()=>{
        if(racialDeclarationBox){
          racialDeclarationBox.scrollTop = racialDeclarationBox.scrollHeight;
          handleScrollable(racialDeclarationBox, racialCheckbox, racialHint);
        }
        if(responsibilityBox){
          responsibilityBox.scrollTop = responsibilityBox.scrollHeight;
          handleScrollable(responsibilityBox, responsibilityCheckbox, responsibilityHint);
        }
        if(racialCheckbox){
          markDeclarationReady(racialCheckbox, racialHint);
          racialCheckbox.checked = true;
        }
        if(responsibilityCheckbox){
          markDeclarationReady(responsibilityCheckbox, responsibilityHint);
          responsibilityCheckbox.checked = true;
        }
        refreshSubmitState();
      });
      declineAllBtn?.addEventListener('click', ()=>{
        if(racialCheckbox){
          racialCheckbox.checked = false;
        }
        if(responsibilityCheckbox){
          responsibilityCheckbox.checked = false;
        }
        refreshSubmitState();
      });

      function updateReview(){
        const nome=$('#nome').value;
        const email=($('#email').value||'').toLowerCase();
        const cpf=fmtCPF($('#cpf').value);
        const telPrincipal = fmtPhone($('#tel1').value);
        const telAdicional = fmtPhone($('#tel2').value);
        const nasc = fmtDateBr($('#nasc').value);
        const nacionalidade = $('#nacionalidade').value;
        const naturalidade = joinParts([
          $('#naturalidade_cidade').value,
          ($('#naturalidade_uf').value||'').toUpperCase()
        ]);
        const rgNumero = $('#rg_numero').value;
        const rgOrgao = $('#rg_orgao').value;
        const rgUf = ($('#rg_uf').value||'').toUpperCase();
        const rgData = fmtDateBr($('#rg_data').value);
        const cep=fmtCEP($('#cep').value);
        const logradouro = joinParts([
          $('#logradouro').value,
          $('#numero').value ? `Nº ${$('#numero').value}` : ''
        ], ', ');
        const complemento = $('#complemento').value;
        const bairro = $('#bairro').value;
        const cidadeUf = joinParts([
          $('#cidade').value,
          ($('#uf').value||'').toUpperCase()
        ], ' / ');
        const genero=$('#genero').value;
        const raca=$('#raca').value;
        const pnp=$('#cotasPNP').value;
        const nivel=$('#nivel').value;
        const ies=$('#ies').value;
        const curso=$('#curso').value;
        const ano=$('#ano_conclusao').value;
        const militarValue=document.querySelector('input[name="militar"]:checked')?.value || '';
        const militar = militarValue==='SIM' ? 'Sim' : militarValue==='NAO' ? 'Não' : '';
        const politicosValue=document.querySelector('input[name="politicos"]:checked')?.value || '';
        const politicos = politicosValue==='SIM' ? 'Sim' : politicosValue==='NAO' ? 'Não' : '';
        const titulo=$('#titulo').value;
        const zona=$('#zona').value;
        const secao=$('#secao').value;
        const isPcd=$('#is_pcd').value;
        const tipoPcd=$('#tipo_pcd').value;
        const necessidade=$('#necessidade').value;
        const vinculoPublico=$('#vinculo_publico').value;
        const qualVinculo=$('#qual_vinculo').value;
        const pisPasep=$('#pis_pasep').value;
        const experienciaTempo=$('#experiencia_tempo').value;

        const reviewSections = [
          { title:'Dados pessoais', rows:[
            {label:'Nome completo', value: present(nome)},
            {label:'Data de nascimento', value: present(nasc)},
            {label:'Nacionalidade', value: present(nacionalidade)},
            {label:'Naturalidade', value: present(naturalidade)}
          ]},
          { title:'Documentos', rows:[
            {label:'RG', value: present(rgNumero)},
            {label:'Órgão expedidor', value: present(rgOrgao)},
            {label:'UF do RG', value: present(rgUf)},
            {label:'Data de expedição', value: present(rgData)},
            {label:'CPF', value: present(cpf)}
          ]},
          { title:'Contatos', rows:[
            {label:'E-mail', value: present(email)},
            {label:'Telefone principal', value: present(telPrincipal)},
            {label:'Telefone adicional', value: present(telAdicional)}
          ]},
          { title:'Endereço', rows:[
            {label:'CEP', value: present(cep)},
            {label:'Logradouro / número', value: present(logradouro)},
            {label:'Complemento', value: present(complemento)},
            {label:'Bairro', value: present(bairro)},
            {label:'Cidade / UF', value: present(cidadeUf)}
          ]},
          { title:'Escolaridade e formação', rows:[
            {label:'Nível', value: present(nivel)},
            {label:'Curso', value: present(curso)},
            {label:'Instituição', value: present(ies)},
            {label:'Ano de conclusão', value: present(ano)}
          ]},
          { title:'Raça e gênero', rows:[
            {label:'Gênero', value: present(genero)},
            {label:'Cor/Raça (IBGE)', value: present(raca)},
            {label:'Concorrer às vagas PNP?', value: present(pnp)}
          ]},
          { title:'Situação militar e eleitoral', rows:[
            {label:'Obrigações militares', value: present(militar)},
            {label:'Direitos políticos', value: present(politicos)},
            {label:'Título de eleitor', value: present(titulo)},
            {label:'Zona', value: present(zona)},
            {label:'Seção', value: present(secao)}
          ]},
          { title:'Pessoa com deficiência (PCD)', rows:[
            {label:'É PCD?', value: present(isPcd)},
            {label:'Tipo de deficiência', value: present(tipoPcd)},
            {label:'Necessidade especial', value: present(necessidade)}
          ]},
          { title:'Vínculos e experiência', rows:[
            {label:'Vínculo com serviço público?', value: present(vinculoPublico)},
            {label:'Qual vínculo', value: present(qualVinculo)},
            {label:'PIS/PASEP', value: present(pisPasep)},
            {label:'Tempo de experiência', value: present(experienciaTempo)}
          ]}
        ];

        const renderRow = ({label, value}) => `
              <tr>
                <td width="240"><strong>${esc(label)}</strong></td>
                <td>${value}</td>
              </tr>
            `;
        const renderSection = (section) => `
          <section class="mb-4">
            <h3 class="h6 section-title mb-2">${esc(section.title)}</h3>
            <table class="table table-sm review-table mb-0">
              <tbody>
                ${section.rows.map(renderRow).join('')}
              </tbody>
            </table>
          </section>
        `;

        $('#reviewBlock').innerHTML = reviewSections.map(renderSection).join('\n');
        updateRacialDeclaration();
      }

      // ========= Submit state =========
      function baseFieldsOk(){
        const ids = ['nome','nasc','nacionalidade','naturalidade_cidade','naturalidade_uf','rg_numero','rg_orgao','rg_uf','rg_data','cpf','email','tel1','cep','logradouro','numero','bairro','cidade','uf','nivel','ies','curso','ano_conclusao','genero','raca','cotasPNP','is_pcd','vinculo_publico'];
        for(const id of ids){ const el=document.getElementById(id); if(!el || !String(el.value||'').trim()) return false; }
        if(!isAdult($('#nasc').value)) return false;
        if(!isValidCPF($('#cpf').value)) return false;
        if(!isValidEmail($('#email').value)) return false;
        if(!isValidPhone($('#tel1').value)) return false;
        const tel2Val = $('#tel2')?.value || '';
        if(tel2Val && !isValidPhone(tel2Val)) return false;
        if($('#vinculo_publico').value === 'Sim'){
          if(!String($('#qual_vinculo').value||'').trim()) return false;
          if(!String($('#experiencia_tempo').value||'').trim()) return false;
        }
        if($('#is_pcd').value === 'Sim'){
          if(!String($('#tipo_pcd').value||'').trim()) return false;
          if(!String($('#necessidade').value||'').trim()) return false;
        }
        return true;
      }
      function docsRequiredOk(){
        const req = ['doc_id_frente','doc_id_verso','doc_residencia','doc_quitacao_eleitoral','doc_escolaridade'];
        for(const id of req){ const el=document.getElementById(id); const ok=checkFiles(el,{required:true}).ok; if(!ok) return false; }
        if(isGeneroMasculino()){
          const militarOk = checkFiles(document.getElementById('doc_militar'), {required:true}).ok;
          if(!militarOk) return false;
        }
        if($('#cotasPNP').value==='Sim'){
          const hv = checkFiles($('#het_video'), {video:true});
          const hf = checkFiles($('#het_frente'), {});
          if(!hv.ok || !hf.ok) return false;
        }
        if($('#is_pcd').value==='Sim'){
          const lp = checkFiles($('#pcd_laudo'), {required:true});
          if(!lp.ok) return false;
        }
        return true;
      }
      function refreshSubmitState(){
        const btn=$('#btnSubmitAll');
        const termoOk = responsibilityCheckbox ? responsibilityCheckbox.checked : true;
        const racialOk = racialCheckbox ? racialCheckbox.checked : true;
        const allOk = baseFieldsOk() && docsRequiredOk() && termoOk && racialOk;
        btn.disabled = !allOk;
        btn.classList.toggle('btn-success', allOk);
        btn.classList.toggle('btn-secondary', !allOk);
      }

      const stepPanels = Array.from(document.querySelectorAll('.step-panel'));
      const wizardSteps = Array.from(document.querySelectorAll('.wizard-step'));
      const progressBar = $('#wizardProgressBar');
      let currentStepIndex = 0;

      function goToStep(index, {scroll=true}={}){
        if(stepPanels.length === 0) return;
        const clamped = Math.max(0, Math.min(index, stepPanels.length - 1));
        currentStepIndex = clamped;
        stepPanels.forEach((panel,i)=>{
          const active = i === clamped;
          panel.classList.toggle('active', active);
          panel.setAttribute('aria-hidden', active ? 'false' : 'true');
        });
        wizardSteps.forEach((item,i)=>{
          const isActive = i === clamped;
          item.classList.toggle('active', isActive);
          item.classList.toggle('completed', i < clamped);
          item.setAttribute('aria-selected', isActive ? 'true' : 'false');
          item.setAttribute('tabindex', isActive ? '0' : '-1');
        });
        if(progressBar){
          const percent = stepPanels.length > 1 ? (clamped/(stepPanels.length - 1))*100 : 100;
          progressBar.style.width = `${percent}%`;
          progressBar.setAttribute('aria-valuenow', String(Math.round(percent)));
        }
        if(scroll){
          const frame = document.querySelector('.frame-card');
          if(frame){
            window.scrollTo({ top: Math.max(0, frame.offsetTop - 24), behavior:'smooth' });
          }
        }
      }

      function handleStepNav(event){
        const dir = event.currentTarget.getAttribute('data-step-nav');
        if(dir === 'next') goToStep(currentStepIndex + 1);
        if(dir === 'prev') goToStep(currentStepIndex - 1);
      }

      function bindWizard(){
        document.querySelectorAll('[data-step-nav]').forEach(btn=>{
          btn.addEventListener('click', handleStepNav);
        });
        wizardSteps.forEach((step,i)=>{
          const activate = ()=>{
            if(i === currentStepIndex) return;
            goToStep(i);
          };
          step.addEventListener('click', activate);
          step.addEventListener('keydown', evt=>{
            if(evt.key === 'Enter' || evt.key === ' '){
              evt.preventDefault();
              activate();
            }
          });
        });
        goToStep(0, {scroll:false});
      }

      // ========= Listeners / Masks =========
      function bindNumeric(id, maxlen){ const el=$(id); if(!el) return;
        el.addEventListener('input', e=>{ e.target.value=onlyDigits(e.target.value).slice(0,maxlen); updateReview(); refreshSubmitState(); });
        el.addEventListener('keydown', e=>{
          if(e.ctrlKey||e.metaKey||e.altKey) return;
          const allowed=['Backspace','Tab','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Delete','Home','End'];
          if(allowed.includes(e.key)) return;
          if(/^[0-9]$/.test(e.key)) return;
          e.preventDefault();
        });
        el.addEventListener('paste', e=>{
          e.preventDefault();
          const input=e.target;
          const paste=onlyDigits((e.clipboardData||window.clipboardData).getData('text'));
          const start=input.selectionStart||0, end=input.selectionEnd||0;
          const nv=(input.value.slice(0,start)+paste+input.value.slice(end)).slice(0,maxlen);
          input.value=nv; requestAnimationFrame(()=>{ input.setSelectionRange(nv.length,nv.length); input.dispatchEvent(new Event('input',{bubbles:true})); });
        });
      }
      function bindPhoneInput(id, helpId, {required=false}={}){
        const input=$(id);
        if(!input) return;
        const help = helpId ? $(helpId) : null;
        const apply = (value)=>{
          const digits = onlyDigits(value).slice(0,11);
          input.value = digits;
          const hasDigits = digits.length > 0;
          const valid = hasDigits ? isValidPhone(digits) : !required;
          input.setCustomValidity(valid ? '' : (hasDigits ? 'Informe um telefone válido com DDD.' : ''));
          if(help){
            help.textContent = hasDigits && !valid ? 'Informe um telefone válido com DDD.' : '';
          }
          refreshSubmitState();
          updateReview();
        };
        input.addEventListener('input', e=>{ apply(e.target.value); });
        input.addEventListener('blur', ()=>apply(input.value));
        input.addEventListener('keydown', e=>{
          if(e.ctrlKey||e.metaKey||e.altKey) return;
          const allowed=['Backspace','Tab','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Delete','Home','End'];
          if(allowed.includes(e.key)) return;
          if(/^[0-9]$/.test(e.key)) return;
          e.preventDefault();
        });
        input.addEventListener('paste', e=>{
          e.preventDefault();
          const paste = (e.clipboardData||window.clipboardData).getData('text');
          apply(paste);
        });
        apply(input.value);
      }
      function bindUppercase(id){
        const el=$(id);
        if(!el) return;
        el.addEventListener('input', e=>{
          const {selectionStart, selectionEnd} = e.target;
          e.target.value = (e.target.value||'').toUpperCase();
          if(typeof selectionStart==='number' && typeof selectionEnd==='number'){
            e.target.setSelectionRange(selectionStart, selectionEnd);
          }
        });
        el.addEventListener('blur', e=>{ e.target.value = (e.target.value||'').toUpperCase(); });
      }
      bindNumeric('#cpf',11);
      bindNumeric('#rg_numero',14);
      bindNumeric('#cep',8);
      bindNumeric('#ano_conclusao',4);
      bindNumeric('#pis_pasep',11);
      bindNumeric('#titulo',12);
      bindNumeric('#zona',4);
      bindNumeric('#secao',4);
      bindPhoneInput('#tel1','#tel1Help',{required:true});
      bindPhoneInput('#tel2','#tel2Help',{required:false});
      bindUppercase('#rg_orgao');
      bindUppercase('#rg_uf');
      bindUppercase('#naturalidade_uf');
      bindUppercase('#uf');

      function updateDocMilitarStatus(){
        const input = $('#doc_militar');
        const status = document.getElementById('status_doc_militar');
        if(!input || !status) return;
        if(!isGeneroMasculino()){
          resetUploaderStatus('status_doc_militar');
          return;
        }
        const res = checkFiles(input, { required: true });
        if(res.ok) ok(status, res.msg); else bad(status, res.msg);
      }

      function toggleGeneroDependents(){
        const isMasc = isGeneroMasculino();
        document.querySelectorAll('input[name="militar"]').forEach(radio=>{
          radio.required = isMasc;
          if(!isMasc) radio.checked = false;
        });
        const militarWrap = $('#militarPergunta');
        if(militarWrap){
          militarWrap.classList.toggle('d-none', !isMasc);
        }
        const militarLabel = $('#militarPerguntaLabel');
        if(militarLabel){
          militarLabel.classList.toggle('required', isMasc);
        }
        const docWrap = $('#docMilitarWrap');
        if(docWrap){
          docWrap.classList.toggle('d-none', !isMasc);
        }
        const docLabel = $('#docMilitarLabel');
        if(docLabel){
          docLabel.classList.toggle('required', isMasc);
        }
        const statusWrap = $('#status_doc_militar_wrap');
        if(statusWrap){
          statusWrap.classList.toggle('d-none', !isMasc);
        }
        const docInput = $('#doc_militar');
        if(docInput){
          docInput.required = isMasc;
          if(!isMasc){
            docInput.value='';
            resetUploaderStatus('status_doc_militar');
          }else{
            updateDocMilitarStatus();
          }
        }
        refreshSubmitState();
      }
      $('#genero')?.addEventListener('change', toggleGeneroDependents);

      function toggleVinculoDetails(){
        const wrap = $('#vinculoDetalhes');
        const show = $('#vinculo_publico')?.value === 'Sim';
        wrap?.classList.toggle('d-none', !show);
        ['#qual_vinculo','#experiencia_tempo'].forEach(sel=>{
          const field=$(sel);
          if(!field) return;
          field.required = show;
          if(!show){ field.value=''; }
        });
        updateReview();
        refreshSubmitState();
      }
      $('#vinculo_publico')?.addEventListener('change', toggleVinculoDetails);

      function togglePcdDetails(){
        const isSim = $('#is_pcd')?.value === 'Sim';
        const wrap = $('#pcdDetalhes');
        const docs = $('#pcdDocsSection');
        wrap?.classList.toggle('d-none', !isSim);
        docs?.classList.toggle('d-none', !isSim);
        ['#tipo_pcd','#necessidade'].forEach(sel=>{
          const field=$(sel);
          if(!field) return;
          field.required = isSim;
          if(!isSim){ field.value=''; }
        });
        const laudo=$('#pcd_laudo');
        if(laudo){
          laudo.required = isSim;
        }
        const status=$('#status_pcd_laudo');
        if(!isSim){
          if(laudo){ laudo.value=''; }
          if(status){ status.textContent=''; status.className='uploader-status ms-auto'; }
        }else if(status && laudo){
          const result = checkFiles(laudo, {required:true});
          if(result.ok) ok(status, result.msg); else bad(status, result.msg);
        }
        updateReview();
        refreshSubmitState();
      }
      $('#is_pcd')?.addEventListener('change', togglePcdDetails);

      const nascInput = $('#nasc');
      nascInput?.addEventListener('change', e=>{
        const value = e.target.value;
        if(value && !isAdult(value)){
          alert('A inscrição é permitida apenas para maiores de 18 anos.');
          e.target.value='';
          e.target.focus();
        }
        refreshSubmitState();
      });

      $('#email').addEventListener('input', e=>{
        e.target.value = (e.target.value||'').toLowerCase();
        const v=e.target.value.trim(); const ok=isValidEmail(v);
        e.target.setCustomValidity(v && !ok ? 'E-mail inválido' : '');
        $('#emailHelp').textContent = v ? (ok ? '' : 'Informe um e-mail válido.') : '';
        refreshSubmitState(); updateReview();
      });
      $('#cpf').addEventListener('input', e=>{
        const ok=isValidCPF(e.target.value);
        $('#cpfHelp').textContent = ok? '' : 'CPF inválido';
        refreshSubmitState();
      });

      // CEP auto-complete
      $('#cep').addEventListener('blur', autofillAddressByCep);
      $('#cep').addEventListener('change', autofillAddressByCep);

      // Upload validators (badges)
      function bindChecker(inputId, statusId, opts){
        const input=document.getElementById(inputId);
        const stat=document.getElementById(statusId);
        const handler=()=>{
          const cfg = typeof opts === 'function' ? opts() : (opts||{});
          const res=checkFiles(input, cfg);
          if(res.ok) ok(stat, res.msg); else bad(stat, res.msg);
          refreshSubmitState();
        };
        input?.addEventListener('change', handler);
      }
      bindChecker('doc_id_frente','status_doc_id_frente',{required:true});
      bindChecker('doc_id_verso','status_doc_id_verso',{required:true});
      bindChecker('doc_residencia','status_doc_res',{required:true});
      bindChecker('doc_quitacao_eleitoral','status_doc_eleitoral',{required:true});
      bindChecker('doc_militar','status_doc_militar',()=>({required: isGeneroMasculino()}));
      bindChecker('doc_escolaridade','status_doc_escolaridade',{required:true});
      bindChecker('doc_curriculo','status_doc_curriculo',{});
      bindChecker('het_id','status_het_id',{});
      const hetVideo=$('#het_video'); const statusHetVideo=document.createElement('div'); hetVideo?.parentElement?.appendChild(statusHetVideo);
      hetVideo?.addEventListener('change', ()=>{ const res=checkFiles(hetVideo,{video:true}); if(res.ok) ok(statusHetVideo,res.msg); else bad(statusHetVideo,res.msg); refreshSubmitState(); });
      bindChecker('pcd_laudo','status_pcd_laudo',()=>({required: $('#is_pcd')?.value === 'Sim'}));

      function populateDocIdFields(payload){
        const entry = Array.isArray(payload)
          ? payload.find(item => item && typeof item === 'object')
          : (payload && typeof payload === 'object' ? payload : null);
        if(!entry) return;
        const nome = pickDataValue(entry,['nome','nome_completo','name','fullName']);
        if(nome) applyIfEmpty('#nome', nome);
        const cpfValue = pickDataValue(entry,['cpf','CPF','cpfNumero']);
        const cpfDigits = onlyDigits(cpfValue).slice(0,11);
        const cpfValid = cpfDigits.length === 11 && isValidCPF(cpfDigits);
        if(cpfValid) applyIfEmpty('#cpf', cpfDigits);
        const docNumberRaw = pickDataValue(entry,['num_doc']);
        if(docNumberRaw){
          const docDigits = onlyDigits(docNumberRaw);
          if(docDigits){
            if(!cpfValid && docDigits.length === 11 && isValidCPF(docDigits)){
              applyIfEmpty('#cpf', docDigits.slice(0,11));
            }
            applyIfEmpty('#rg_numero', docDigits.slice(0,14));
          }else{
            applyIfEmpty('#rg_numero', docNumberRaw);
          }
        }
        const nascIso = parseToIsoDate(pickDataValue(entry,['data_nascimento','dataNascimento','nascimento','birthDate']));
        if(nascIso) applyIfEmpty('#nasc', nascIso);
        const nacionalidade = pickDataValue(entry,['nacionalidade']);
        if(nacionalidade) applyIfEmpty('#nacionalidade', nacionalidade, v => String(v).toUpperCase());
        const naturalidadeCidade = pickDataValue(entry,['naturalidade','naturalidade_cidade','cidade_naturalidade']);
        if(naturalidadeCidade) applyIfEmpty('#naturalidade_cidade', naturalidadeCidade, v => String(v).toUpperCase());
        const naturalidadeUf = pickDataValue(entry,['naturalidade_uf','uf_naturalidade','naturalidadeUf']);
        if(naturalidadeUf) applyIfEmpty('#naturalidade_uf', naturalidadeUf, v => String(v).toUpperCase());
        const rgNumero = pickDataValue(entry,['rg','rg_numero','numero_rg']);
        if(rgNumero) applyIfEmpty('#rg_numero', onlyDigits(rgNumero).slice(0,14));
        const rgOrgao = pickDataValue(entry,['rg_orgao','orgao_emissor','orgaoExpedidor','orgao']);
        if(rgOrgao) applyIfEmpty('#rg_orgao', rgOrgao, v => String(v).toUpperCase());
        const rgUf = pickDataValue(entry,['rg_uf','uf_rg','uf_doc']);
        if(rgUf) applyIfEmpty('#rg_uf', rgUf, v => String(v).toUpperCase());
        const rgData = parseToIsoDate(pickDataValue(entry,['rg_expedicao','data_expedicao','rg_data','exp_doc']));
        if(rgData) applyIfEmpty('#rg_data', rgData);
        const pisValue = pickDataValue(entry,['pis','pis_pasep']);
        if(pisValue) applyIfEmpty('#pis_pasep', onlyDigits(pisValue).slice(0,11));
        updateReview();
        refreshSubmitState();
      }

      function populateQuitacaoFields(data){
        if(!data) return;
        const titulo = pickDataValue(data,['titulo','titulo_eleitoral','tituloEleitoral']);
        if(titulo) applyIfEmpty('#titulo', onlyDigits(titulo).slice(0,12));
        const zona = pickDataValue(data,['zona','zona_eleitoral']);
        if(zona) applyIfEmpty('#zona', onlyDigits(zona).slice(0,4));
        const secao = pickDataValue(data,['secao','seção','secao_eleitoral']);
        if(secao) applyIfEmpty('#secao', onlyDigits(secao).slice(0,4));
        updateReview();
        refreshSubmitState();
      }

      function populateResidenciaFields(data){
        if(!data) return;
        const cep = pickDataValue(data,['cep','codigo_postal','postalCode']);
        if(cep) applyIfEmpty('#cep', onlyDigits(cep).slice(0,8));
        const logradouro = pickDataValue(data,['logradouro','address','rua','street']);
        if(logradouro) applyIfEmpty('#logradouro', logradouro, v => String(v).toUpperCase());
        const numero = pickDataValue(data,['numero','numero_imovel','numeroEndereco']);
        if(numero) applyIfEmpty('#numero', numero, v => String(v).toUpperCase());
        const complemento = pickDataValue(data,['complemento','complement']);
        if(complemento) applyIfEmpty('#complemento', complemento, v => String(v).toUpperCase());
        const bairro = pickDataValue(data,['bairro','district','bairroEndereco']);
        if(bairro) applyIfEmpty('#bairro', bairro, v => String(v).toUpperCase());
        const cidade = pickDataValue(data,['cidade','localidade','municipio','city']);
        if(cidade) applyIfEmpty('#cidade', cidade, v => String(v).toUpperCase());
        const uf = pickDataValue(data,['uf','estado','state']);
        if(uf) applyIfEmpty('#uf', uf, v => String(v).toUpperCase());
        updateReview();
        refreshSubmitState();
        if(cep) autofillAddressByCep();
      }

      function populateEscolaridadeFields(data){
        if(!data) return;
        const nivel = pickDataValue(data,['nivel','nivel_escolaridade','escolaridade']);
        if(nivel) applyIfEmpty('#nivel', nivel);
        const instituicao = pickDataValue(data,['instituicao','instituicao_ensino','ies','instituicaoEnsino']);
        if(instituicao) applyIfEmpty('#ies', instituicao);
        const curso = pickDataValue(data,['curso','curso_nome','cursoNome']);
        if(curso) applyIfEmpty('#curso', curso);
        const ano = pickDataValue(data,['ano','ano_conclusao','anoConclusao']);
        if(ano) applyIfEmpty('#ano_conclusao', onlyDigits(ano).slice(0,4));
        updateReview();
        refreshSubmitState();
      }

      async function uploadDocIdBundle(){
        const frente = document.getElementById('doc_id_frente');
        const verso = document.getElementById('doc_id_verso');
        const statusVerso = document.getElementById('status_doc_id_verso');
        if(!frente || !verso || !statusVerso) return;
        const frontStatus = document.getElementById('status_doc_id_frente');
        if(!verso.files || verso.files.length === 0){
          resetUploaderStatus('status_doc_id_verso');
          refreshSubmitState();
          return;
        }
        if(!frente.files || frente.files.length === 0){
          if(frontStatus) bad(frontStatus,'Selecione a frente');
          refreshSubmitState();
          return;
        }
        const frontCheck = checkFiles(frente,{required:true});
        if(!frontCheck.ok){
          if(frontStatus) bad(frontStatus, frontCheck.msg);
          refreshSubmitState();
          return;
        }
        const backCheck = checkFiles(verso,{required:true});
        if(!backCheck.ok){
          bad(statusVerso, backCheck.msg);
          refreshSubmitState();
          return;
        }
        const frontFile = frente.files[0];
        const backFile = verso.files[0];
        if(!frontFile || !backFile) return;
        const fd = new FormData();
        fd.append('doc_frente', frontFile, frontFile.name);
        fd.append('doc_verso', backFile, backFile.name);
        setStatus(statusVerso,'info','Enviando...',true);
        try{
          const out = await postForm(DOC_ID_ENDPOINT, fd);
          if(out.ok){
            ok(statusVerso,'Enviado');
            if(frontStatus) ok(frontStatus,'Enviado');
            populateDocIdFields(out.data || {});
          }else{
            bad(statusVerso, `Erro ${out.status}`);
            if(frontStatus) bad(frontStatus, `Erro ${out.status}`);
          }
        }catch(e){
          console.error('doc-id upload fail', e);
          bad(statusVerso,'Falha no envio');
          if(frontStatus) bad(frontStatus,'Falha no envio');
        }
        refreshSubmitState();
      }

      async function uploadSingleDocument(inputId, statusId, endpoint, fileKey, onData){
        const input=document.getElementById(inputId);
        const status=document.getElementById(statusId);
        if(!input || !status) return;
        if(!input.files || input.files.length === 0){
          resetUploaderStatus(statusId);
          refreshSubmitState();
          return;
        }
        const res=checkFiles(input,{required:true});
        if(!res.ok){ bad(status,res.msg); refreshSubmitState(); return; }
        const file=input.files[0];
        if(!file){
          resetUploaderStatus(statusId);
          refreshSubmitState();
          return;
        }
        const fd=new FormData();
        fd.append(fileKey, file, file.name);
        setStatus(status,'info','Enviando...',true);
        try{
          const out=await postForm(endpoint, fd);
          if(out.ok){
            ok(status,'Enviado');
            if(onData && out.data){ onData(out.data); }
          }else{
            bad(status, `Erro ${out.status}`);
          }
        }catch(e){
          console.error('upload fail', e);
          bad(status,'Falha no envio');
        }
        refreshSubmitState();
      }

      document.getElementById('doc_id_verso')?.addEventListener('change', uploadDocIdBundle);
      document.getElementById('doc_id_frente')?.addEventListener('change', ()=>{
        const verso = document.getElementById('doc_id_verso');
        if(verso?.files?.length){
          uploadDocIdBundle();
        }
      });
      document.getElementById('doc_quitacao_eleitoral')?.addEventListener('change', ()=> uploadSingleDocument('doc_quitacao_eleitoral','status_doc_eleitoral', QUITACAO_ENDPOINT,'doc_quitacao_eleitoral', populateQuitacaoFields));
      document.getElementById('doc_residencia')?.addEventListener('change', ()=> uploadSingleDocument('doc_residencia','status_doc_res', RESIDENCIA_ENDPOINT,'doc_residencia', populateResidenciaFields));
      document.getElementById('doc_escolaridade')?.addEventListener('change', ()=> uploadSingleDocument('doc_escolaridade','status_doc_escolaridade', ESCOLARIDADE_ENDPOINT,'doc_escolaridade', populateEscolaridadeFields));

      // ========= Draft (localStorage) =========
      const DRAFT_KEY='hvr_inscricao_draft_v1';
      const watchedSelectors = [
        '#nome','#nasc','#nacionalidade','#naturalidade_cidade','#naturalidade_uf',
        '#rg_numero','#rg_orgao','#rg_uf','#rg_data','#cpf','#email','#tel1','#tel2','#cep','#logradouro','#numero','#complemento','#bairro','#cidade','#uf',
        '#nivel','#ies','#curso','#ano_conclusao','#genero','#raca','#cotasPNP','#is_pcd','#tipo_pcd','#necessidade',
        '#vinculo_publico','#qual_vinculo','#pis_pasep','#experiencia_tempo','#titulo','#zona','#secao'
      ];
      function saveDraft(){
        const data={};
        for(const sel of watchedSelectors){ const el=$(sel); if(!el) continue; data[sel]=el.value; }
        localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
      }
      function loadDraft(){
        try{
          const data=JSON.parse(localStorage.getItem(DRAFT_KEY)||'{}');
          Object.entries(data).forEach(([sel,val])=>{
            const el=$(sel);
            if(el && typeof val==='string'){
              el.value=val;
              el.dispatchEvent(new Event('input',{bubbles:true}));
            }
          });
        }catch(e){}
      }
      $('#quickSave').addEventListener('click', ()=>{
        saveDraft();
        const btn=$('#quickSave'); const old=btn.textContent; btn.textContent='Rascunho salvo'; setTimeout(()=>btn.textContent=old,1500);
      });

      // ========= Build FormData & Enviar =========
      function appendIfFile(fd, id, key){
        const input=document.getElementById(id);
        if(!input) return;
        const files=Array.from(input.files||[]);
        files.forEach((f,idx)=> fd.append(key || id + (files.length>1?`[${idx}]`:''), f, f.name));
      }
      function buildFormData(){
        const fd=new FormData();
        // pessoais
        fd.append('nome',$('#nome').value.trim());
        fd.append('data_nascimento',$('#nasc').value);
        fd.append('nacionalidade',$('#nacionalidade').value.trim());
        fd.append('naturalidade_cidade',$('#naturalidade_cidade').value.trim());
        fd.append('naturalidade_uf',$('#naturalidade_uf').value.trim().toUpperCase());
        fd.append('rg_numero',$('#rg_numero').value.trim());
        fd.append('rg_orgao',$('#rg_orgao').value.trim().toUpperCase());
        fd.append('rg_uf',$('#rg_uf').value.trim().toUpperCase());
        fd.append('rg_data',$('#rg_data').value);
        fd.append('cpf', onlyDigits($('#cpf').value));
        fd.append('email',$('#email').value.trim().toLowerCase());
        fd.append('telefone1',onlyDigits($('#tel1').value));
        fd.append('telefone2',onlyDigits($('#tel2').value));
        // endereço
        fd.append('cep',onlyDigits($('#cep').value));
        fd.append('logradouro',$('#logradouro').value.trim());
        fd.append('numero',$('#numero').value.trim());
        fd.append('complemento',$('#complemento').value.trim());
        fd.append('bairro',$('#bairro').value.trim());
        fd.append('cidade',$('#cidade').value.trim());
        fd.append('uf',$('#uf').value.trim().toUpperCase());
        // formação
        fd.append('nivel_minimo',$('#nivel').value);
        fd.append('ies',$('#ies').value.trim());
        fd.append('curso',$('#curso').value.trim());
        fd.append('ano_conclusao',$('#ano_conclusao').value.trim());
        // raça/gênero
        fd.append('genero',$('#genero').value);
        fd.append('raca',$('#raca').value);
        fd.append('concorrer_pnp',$('#cotasPNP').value);
        fd.append('autodeclaracao_racial', racialCheckbox && racialCheckbox.checked ? 'ACEITO' : 'NAO');
        fd.append('autodeclaracao_racial_texto', (racialDeclarationBox?.innerText || '').trim());
        // pcd
        fd.append('is_pcd',$('#is_pcd').value);
        fd.append('tipo_pcd',$('#tipo_pcd').value.trim());
        fd.append('necessidade',$('#necessidade').value.trim());
        // militar/eleitoral
        fd.append('militar', document.querySelector('input[name="militar"]:checked')?.value || '');
        fd.append('politicos', document.querySelector('input[name="politicos"]:checked')?.value || '');
        fd.append('titulo',onlyDigits($('#titulo').value));
        fd.append('zona',onlyDigits($('#zona').value));
        fd.append('secao',onlyDigits($('#secao').value));
        // vínculos
        fd.append('vinculo_publico',$('#vinculo_publico').value);
        fd.append('qual_vinculo',$('#qual_vinculo').value.trim());
        fd.append('pis_pasep',$('#pis_pasep').value.trim());
        fd.append('experiencia_tempo',$('#experiencia_tempo').value.trim());
        fd.append('termo_responsabilidade', responsibilityCheckbox && responsibilityCheckbox.checked ? 'ACEITO' : 'NAO');

        // uploads
        appendIfFile(fd,'doc_id_frente','doc_id_frente');
        appendIfFile(fd,'doc_id_verso','doc_id_verso');
        appendIfFile(fd,'doc_residencia','doc_residencia');
        appendIfFile(fd,'doc_quitacao_eleitoral','doc_quitacao_eleitoral');
        appendIfFile(fd,'doc_militar','doc_militar');
        appendIfFile(fd,'doc_escolaridade','doc_escolaridade');
        appendIfFile(fd,'doc_curriculo','doc_curriculo');
        appendIfFile(fd,'het_id','het_id');
        appendIfFile(fd,'het_frente','het_frente');
        appendIfFile(fd,'het_perfil','het_perfil');
        appendIfFile(fd,'het_video','het_video');
        appendIfFile(fd,'pcd_laudo','pcd_laudo');

        return fd;
      }
      async function postForm(url, formData){
        const res = await fetch(url, { method:'POST', body: formData });
        const text = await res.text();
        let data=null; try{ data=JSON.parse(text); }catch(e){}
        return { ok: res.ok, status: res.status, text, data };
      }
      async function submitAll(){
        if($('#btnSubmitAll').disabled) return;
        try{
          $('#finalStatus').innerHTML = '<span class="badge text-bg-secondary">Enviando...</span>';
          const out = await postForm(FINAL_ENDPOINT, buildFormData());
          if(out.ok){
            alert('Inscrição enviada com sucesso!');
            document.getElementById('app').innerHTML = `<div class="py-5 text-center"><h3 class="mb-3">Sua inscrição foi registrada</h3><p class="text-muted">Acompanhe as publicações oficiais do certame.</p></div>`;
          }else{
            $('#finalStatus').innerHTML = '<span class="badge text-bg-danger">Falha no envio</span>';
            $('#finalOut').textContent = out.text || ''; $('#finalOut').classList.remove('d-none');
          }
        }catch(e){
          $('#finalStatus').innerHTML = '<span class="badge text-bg-danger">Erro de rede</span>';
          $('#finalOut').textContent = String(e); $('#finalOut').classList.remove('d-none');
        }
      }
      document.getElementById('btnSubmitAll').addEventListener('click', submitAll);

      // ========= Init =========
      function attachWatchers(){
        const events=['input','change','blur'];
        document.querySelectorAll('input,select,textarea').forEach(el=>{
          events.forEach(ev=> el.addEventListener(ev, ()=>{ updateReview(); refreshSubmitState(); }));
        });
      }
      function init(){
        loadDraft();
        toggleVinculoDetails();
        togglePcdDetails();
        toggleGeneroDependents();
        bindWizard();
        resetDeclaration(responsibilityBox, responsibilityCheckbox, responsibilityHint);
        attachWatchers();
        updateReview();
        refreshSubmitState();
        autofillAddressByCep();
      }
      init();
    </script>
  </body>
</html>
